"use client";

import useGetParam, { useUpdateSearchParams } from "@/hooks/params";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "../ui/select";
import { Label } from "../ui/label";
import { ReactNode, useEffect, useState } from "react";
import Loader from "../loaders/Loader";
import { cn } from "@/lib/utils";

export interface SelectOption {
  label: string;
  value: string;
}

interface ISelect {
  options: SelectOption[];
  value?: string;
  onChange?: (value: string) => void;
  placeholder?: string;
  className?: string;
  triggerStyles?: string;
  disabled?: boolean;
  required?: boolean;
  name?: string;
  paramKey?: string;
  label?: ReactNode;
  error?: string;
  clearable?: boolean;
}

// Primary Select (like your PrimaryDropdown)
export function PrimarySelect({ clearable = true, ...props }: ISelect) {
  const { setParam } = useUpdateSearchParams();
  const paramValue = useGetParam(props.paramKey as string);

  const [refreshing, setRefreshing] = useState(false);

  // Refresh when paramValue is cleared
  useEffect(() => {
    if (!paramValue) {
      setRefreshing(true);
      setTimeout(() => {
        setRefreshing(false);
      }, 50);
    }
  }, [paramValue]);

  const handleOnChange = (val: string) => {
    const value = val === "all" ? "" : val;
    if (props.onChange) {
      props.onChange(value);
    } else {
      if (props.paramKey) setParam(props.paramKey as string, value);
    }
  };
  const normalizedValue =
    !props.value || props.value === "all" ? undefined : props.value;


  if (refreshing) return <Loader />;

  return (
    <div>
      {props.label && (
        <Label htmlFor={props.name} className="_label mb-2 text-muted-foreground">
          {props.label}
        </Label>
      )}

      <Select
        value={normalizedValue}
        onValueChange={handleOnChange}
        disabled={props.disabled}
        name={props.name}
        required={props.required}
      >
        <SelectTrigger className={`${props.triggerStyles}`} id={props.name}>
          <SelectValue placeholder={props.placeholder ?? "Select"} />
        </SelectTrigger>
        <SelectContent className={props.className}>
          {clearable && (
            <SelectItem value="all">
              <span className="text-muted-foreground">All</span>
            </SelectItem>
          )}
          {props?.options?.map((option) => (
            <SelectItem key={option.value} value={option.value}>
              {option.label}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {props.error && (
        <p className={` text-red-500 text-left text-sm mt-1 font-light`}>
          {props.error}
        </p>
      )}
    </div>
  );
}

interface ISELECT {
  options: SelectOption[];
  value?: string;
  onChange?: (value: string) => void;
  placeholder?: string;
  className?: string;
  selectStyles?: string;

  name?: string;
  paramKey?: string;
  label?: ReactNode;
  error?: string;
  disabled?: boolean;
  required?: boolean;
}

export default function SELECT({
  options,
  name,
  value,
  error,
  onChange,
  label,
  className,
  paramKey,
  ...props
}: ISELECT) {
  const { setParam } = useUpdateSearchParams();

  const handleOnChange = (val: string) => {
    if (typeof onChange !== "undefined") {
      onChange(val);
    } else {
      if (paramKey) setParam((paramKey as string) ?? "filter", val);
    }
  };
  return (
    <div className={cn("flex items-center gap-2 relative", className)}>
      {label && (
        <Label htmlFor={name} className="_label text-muted-foreground">
          {label}
        </Label>
      )}
      <select
        value={value}
        onChange={(e) => handleOnChange?.(e.target.value)}
        className={cn(
          "bg-transparent text-sm border rounded px-2 py-1 h-9",
          props.selectStyles
        )}
        {...props}
      >
        <option value="" hidden>
          {props.placeholder}
        </option>
        {options?.map((op, i) => (
          <option key={i} value={op.value}>
            {op.label}
          </option>
        ))}
      </select>

      {error && (
        <p
          className={`absolute top-full text-red-500 text-left text-sm font-light`}
        >
          {error}
        </p>
      )}
    </div>
  );
}
